<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.134.3"><meta name=description content><meta name=author content="journeyoftheaverageguy@gmail.com"><link rel=icon href=../../../images/favicon.png type=image/png><title>Create a Lambda Function to Convert to Audio :: AWS System Manager</title>
<link href=../../../css/nucleus.css?1753240738 rel=stylesheet><link href=../../../css/fontawesome-all.min.css?1753240738 rel=stylesheet><link href=../../../css/hybrid.css?1753240738 rel=stylesheet><link href=../../../css/featherlight.min.css?1753240738 rel=stylesheet><link href=../../../css/perfect-scrollbar.min.css?1753240738 rel=stylesheet><link href=../../../css/auto-complete.css?1753240738 rel=stylesheet><link href=../../../css/atom-one-dark-reasonable.css?1753240738 rel=stylesheet><link href=../../../css/theme.css?1753240738 rel=stylesheet><link href=../../../css/hugo-theme.css?1753240738 rel=stylesheet><link href=../../../css/theme-workshop.css?1753240738 rel=stylesheet><script src=../../../js/jquery-3.3.1.min.js?1753240738></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=../../../2-prerequiste/2.1-createec2/2.1.5-createec2linux/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=../../../><svg id="Layer_1" data-name="Layer 1" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff}.cls-2{fill:#f90;fill-rule:evenodd}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09 10.85a4.7 4.7.0 00.19 1.48 7.73 7.73.0 00.54 1.19.77.77.0 01.12.38.64.64.0 01-.32.49l-1 .7a.83.83.0 01-.44.15.69.69.0 01-.49-.23 3.8 3.8.0 01-.6-.77q-.25-.42-.51-1a6.14 6.14.0 01-4.89 2.3 4.54 4.54.0 01-3.32-1.19 4.27 4.27.0 01-1.22-3.2 4.28 4.28.0 011.46-3.4A6.06 6.06.0 017.69 6.46a12.47 12.47.0 011.76.13q.92.13 1.91.36V5.73a3.65 3.65.0 00-.79-2.66A3.81 3.81.0 007.86 2.3a7.71 7.71.0 00-1.79.22 12.78 12.78.0 00-1.79.57 4.55 4.55.0 01-.58.22h-.26q-.35.0-.35-.52V2a1.09 1.09.0 01.12-.58 1.2 1.2.0 01.47-.35A10.88 10.88.0 015.77.32 10.19 10.19.0 018.36.0a6 6 0 014.35 1.35 5.49 5.49.0 011.38 4.09zM7.34 13.38a5.36 5.36.0 001.72-.31A3.63 3.63.0 0010.63 12 2.62 2.62.0 0011.19 11a5.63 5.63.0 00.16-1.44v-.7a14.35 14.35.0 00-1.53-.28 12.37 12.37.0 00-1.56-.1 3.84 3.84.0 00-2.47.67A2.34 2.34.0 005 11a2.35 2.35.0 00.61 1.76A2.4 2.4.0 007.34 13.38zm13.35 1.8a1 1 0 01-.64-.16 1.3 1.3.0 01-.35-.65L15.81 1.51a3 3 0 01-.15-.67.36.36.0 01.41-.41H17.7a1 1 0 01.65.16 1.4 1.4.0 01.33.65l2.79 11 2.59-11A1.17 1.17.0 0124.39.6a1.1 1.1.0 01.67-.16H26.4a1.1 1.1.0 01.67.16 1.17 1.17.0 01.32.65L30 12.39 32.88 1.25A1.39 1.39.0 0133.22.6a1 1 0 01.65-.16h1.54a.36.36.0 01.41.41 1.36 1.36.0 010 .26 3.64 3.64.0 01-.12.41l-4 12.86a1.3 1.3.0 01-.35.65 1 1 0 01-.64.16H29.25a1 1 0 01-.67-.17 1.26 1.26.0 01-.32-.67L25.67 3.64l-2.56 10.7a1.26 1.26.0 01-.32.67 1 1 0 01-.67.17zm21.36.44a11.28 11.28.0 01-2.56-.29 7.44 7.44.0 01-1.92-.67 1 1 0 01-.61-.93v-.84q0-.52.38-.52a.9.9.0 01.31.06l.42.17a8.77 8.77.0 001.83.58 9.78 9.78.0 002 .2 4.48 4.48.0 002.43-.55 1.76 1.76.0 00.86-1.57 1.61 1.61.0 00-.45-1.16A4.29 4.29.0 0043 9.22l-2.41-.76A5.15 5.15.0 0138 6.78a3.94 3.94.0 01-.83-2.41 3.7 3.7.0 01.45-1.85 4.47 4.47.0 011.19-1.37 5.27 5.27.0 011.7-.86A7.4 7.4.0 0142.6.0a8.87 8.87.0 011.12.07q.57.07 1.08.19t.95.26a4.27 4.27.0 01.7.29 1.59 1.59.0 01.49.41.94.94.0 01.15.55v.79q0 .52-.38.52a1.76 1.76.0 01-.64-.2 7.74 7.74.0 00-3.2-.64 4.37 4.37.0 00-2.21.47 1.6 1.6.0 00-.79 1.48 1.58 1.58.0 00.49 1.18 4.94 4.94.0 001.83.92L44.55 7a5.08 5.08.0 012.57 1.6A3.76 3.76.0 0147.9 11a4.21 4.21.0 01-.44 1.93 4.4 4.4.0 01-1.21 1.47 5.43 5.43.0 01-1.85.93A8.25 8.25.0 0142.05 15.62z"/><path class="cls-2" d="M45.19 23.81C39.72 27.85 31.78 30 25 30A36.64 36.64.0 01.22 20.57c-.51-.46-.06-1.09.56-.74A49.78 49.78.0 0025.53 26.4 49.23 49.23.0 0044.4 22.53C45.32 22.14 46.1 23.14 45.19 23.81z"/><path class="cls-2" d="M47.47 21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74 3.13-2.2 8.27-1.57 8.86-.83s-.16 5.89-3.09 8.35c-.45.38-.88.18-.68-.32C46.69 25.8 48.17 22.11 47.47 21.21z"/></svg></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=../../../js/lunr.min.js?1753240738></script><script type=text/javascript src=../../../js/auto-complete.js?1753240738></script><script type=text/javascript>var baseurl="https://trinh7.github.io/workshop_JCJ/"</script><script type=text/javascript src=../../../js/search.js?1753240738></script></div><div class=highlightable><ul class=topics><li data-nav-id=/0-tablecontent/ title="Table of Contents" class=dd-item><a href=../../../0-tablecontent/><b>1. </b>Table of Contents
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-introduce/ title=Introduction class=dd-item><a href=../../../1-introduce/><b>2. </b>Introduction
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2-prerequiste/ title="Preparation and implementation steps" class="dd-item
parent"><a href=../../../2-prerequiste/><b>3. </b>Preparation and implementation steps
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/2-prerequiste/2.1-createec2/ title="Prepare Resources" class="dd-item
parent"><a href=../../../2-prerequiste/2.1-createec2/><b>3.1 </b>Prepare Resources
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/2-prerequiste/2.1-createec2/2.1.1-createvpc/ title="Create DynamoDB Table" class=dd-item><a href=../../../2-prerequiste/2.1-createec2/2.1.1-createvpc/><b>3.1.1 </b>Create DynamoDB Table
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2-prerequiste/2.1-createec2/2.1.2-createpublicsubnet/ title="Create an Amazon S3 Bucket" class=dd-item><a href=../../../2-prerequiste/2.1-createec2/2.1.2-createpublicsubnet/><b>3.1.2 </b>Create an Amazon S3 Bucket
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2-prerequiste/2.1-createec2/2.1.3-createprivatesubnet/ title="Create SNS Topic" class=dd-item><a href=../../../2-prerequiste/2.1-createec2/2.1.3-createprivatesubnet/><b>3.1.3 </b>Create SNS Topic
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2-prerequiste/2.1-createec2/2.1.4-createsecgroup/ title="Create a Lambda Function " class=dd-item><a href=../../../2-prerequiste/2.1-createec2/2.1.4-createsecgroup/><b>3.1.4 </b>Create a Lambda Function
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2-prerequiste/2.1-createec2/2.1.5-createec2linux/ title="Create a Lambda Function to Convert to Audio" class="dd-item
active"><a href=../../../2-prerequiste/2.1-createec2/2.1.5-createec2linux/><b>3.1.5 </b>Create a Lambda Function to Convert to Audio
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2-prerequiste/2.1-createec2/2.1.6-createec2windows/ title="Testing the functions" class=dd-item><a href=../../../2-prerequiste/2.1-createec2/2.1.6-createec2windows/><b>3.1.6 </b>Testing the functions
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2-prerequiste/2.1-createec2/2.1.7-getpost/ title="Create a getpost Lambda Function" class=dd-item><a href=../../../2-prerequiste/2.1-createec2/2.1.7-getpost/><b>3.1.7 </b>Create a getpost Lambda Function
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2-prerequiste/2.1-createec2/2.1.8-restful/ title="Exposing Lambda Functions as RESTful Web Services" class=dd-item><a href=../../../2-prerequiste/2.1-createec2/2.1.8-restful/><b>3.1.8 </b>Exposing Lambda Functions as RESTful Web Services
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/2-prerequiste/2.1-createec2/2.1.9-serverlessuser/ title="Create a Serverless UI" class=dd-item><a href=../../../2-prerequiste/2.1-createec2/2.1.9-serverlessuser/><b>3.1.9 </b>Create a Serverless UI
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li><li data-nav-id=/4-cleanup/ title="Conclusion and resource cleanup" class=dd-item><a href=../../../4-cleanup/><b>4. </b>Conclusion and resource cleanup
<i class="fas fa-check read-icon"></i></a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://www.facebook.com/groups/awsstudygroupfcj/><i class='fab fa-facebook'></i> AWS Study Group</a></li></ul></section><section id=prefooter><hr><ul><li><a class=padding><i class="fas fa-language fa-fw"></i><div class=select-style><select id=select-language onchange="location=this.value"><option id=en value=https://trinh7.github.io/workshop_JCJ/2-prerequiste/2.1-createec2/2.1.5-createec2linux/ selected>English</option><option id=vi value=https://trinh7.github.io/workshop_JCJ/vi/2-prerequiste/2.1-createec2/2.1.5-createec2linux/>Tiếng Việt</option></select><svg id="Capa_1" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><polygon points="0,63.75 127.5,191.25 255,63.75"/></g></g></svg></div></a></li><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></section><section id=footer><left><b>Workshop</b><br><img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title=Migrate alt="web counter" border=0></a><br><b><a href=https://cloudjourney.awsstudygroup.com/>Cloud Journey</a></b><br><img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" alt="web counter" border=0>
</left><left><br><br><b>Last Updated</b><br><i><font color=orange>30-01-2022</font></i>
</left><left><br><br><b>Team</b><br><i><a href=https://www.linkedin.com/in/sutrinh/ style=color:orange>Sử Trịnh</a><br><a href=https://www.linkedin.com/in/jotaguy style=color:orange>Gia Hưng</a><br><a href=https://www.linkedin.com/in/hiepnguyendt style=color:orange>Thanh Hiệp </a></i></left><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i>
</a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=../../../>Building a Serverless Text-to-Speech Application with Amazon Polly</a> > <a href=../../../2-prerequiste/>Preparation and implementation steps</a> > <a href=../../../2-prerequiste/2.1-createec2/>Prepare Resources</a> > Create a Lambda Function to Convert to Audio</span></div><div class=progress><div class=wrapper><nav id=TableOfContents></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Create a Lambda Function to Convert to Audio</h1><p><strong>Now you create a Lambda function to convert text stored in a DynamoDB table to an audio file.</strong></p><ol><li>Select <strong>Functions</strong> in the upper left navigation pane.</li></ol><p>Note: You may need to expand the navigation pane by selecting the menu icon.</p><p>1.Select <strong>Create Function.</strong>
2.Select <strong>Author from scratch</strong> and use the following settings:</p><ul><li>Function name: ConvertToAudio</li><li>Runtime: Python 3.12</li><li>Expand Change default execution role</li><li>Execution role: Select Use existing role</li><li>Current role: Select Lab-Lambda-Role</li></ul><p>1.Scroll down and select <strong>Create Function.</strong>
2.Enter code: Delete the existing code and paste the following code:</p><pre><code>   import boto3
   import os
   from contextlib import closing
   from boto3.dynamodb.conditions import Key, Attr
   
      def lambda_handler(event, context):
      
          postId = event[&quot;Records&quot;][0][&quot;Sns&quot;][&quot;Message&quot;]
      
          print (&quot;Text to Speech function. Post ID in DynamoDB: &quot; + postId)
      
          # Retrieving information about the post from DynamoDB table
          dynamodb = boto3.resource('dynamodb')
          table = dynamodb.Table(os.environ['DB_TABLE_NAME'])
          postItem = table.query(
              KeyConditionExpression=Key('id').eq(postId)
          )
      
      
          text = postItem[&quot;Items&quot;][0][&quot;text&quot;]
          voice = postItem[&quot;Items&quot;][0][&quot;voice&quot;]
      
          rest = text
      
          # Because single invocation of the polly synthesize_speech api can
          # transform text with about 3000 characters, we are dividing the
          # post into blocks of approximately 2500 characters.
          textBlocks = []
          while (len(rest) &gt; 2600):
              begin = 0
              end = rest.find(&quot;.&quot;, 2500)
      
              if (end == -1):
                  end = rest.find(&quot; &quot;, 2500)
      
              textBlock = rest[begin:end]
              rest = rest[end:]
              textBlocks.append(textBlock)
          textBlocks.append(rest)
      
          # For each block, invoke Polly API, which transforms text into audio
          polly = boto3.client('polly')
          for textBlock in textBlocks:
              response = polly.synthesize_speech(
                  OutputFormat='mp3',
                  Text = textBlock,
                  VoiceId = voice
              )
      
              # Save the audio stream returned by Amazon Polly on Lambda's temp
              # directory. If there are multiple text blocks, the audio stream
              # is combined into a single file.
              if &quot;AudioStream&quot; in response:
                  with closing(response[&quot;AudioStream&quot;]) as stream:
                      output = os.path.join(&quot;/tmp/&quot;, postId)
                      if os.path.isfile(output):
                          mode = &quot;ab&quot;  # Append binary mode
                      else:
                          mode = &quot;wb&quot;  # Write binary mode (create a new file)
                      with open(output, mode) as file:
                          file.write(stream.read())
      
          s3 = boto3.client('s3')
          s3.upload_file('/tmp/' + postId,
            os.environ['BUCKET_NAME'],
            postId + &quot;.mp3&quot;)
          s3.put_object_acl(ACL='public-read',
            Bucket=os.environ['BUCKET_NAME'],
            Key= postId + &quot;.mp3&quot;)
      
          location = s3.get_bucket_location(Bucket=os.environ['BUCKET_NAME'])
          region = location['LocationConstraint']
      
          if region is None:
              url_beginning = &quot;https://s3.amazonaws.com/&quot;
          else:
              url_beginning = &quot;https://s3-&quot; + str(region) + &quot;.amazonaws.com/&quot;
      
          url = url_beginning \
                  + str(os.environ['BUCKET_NAME']) \
                  + &quot;/&quot; \
                  + str(postId) \
                  + &quot;.mp3&quot;
      
          # Updating the item in DynamoDB
          response = table.update_item(
              Key={'id':postId},
                UpdateExpression=
                  &quot;SET #statusAtt = :statusValue, #urlAtt = :urlValue&quot;,
                ExpressionAttributeValues=
                  {':statusValue': 'UPDATED', ':urlValue': url},
              ExpressionAttributeNames=
                {'#statusAtt': 'status', '#urlAtt': 'url'},
          )
      
          return
</code></pre><p>Check the code. The Lambda function performs the following functions:</p><ul><li>Retrieve the ID of the DynamoDB item (post ID) that needs to be converted to an audio file from the input message (SNS event)</li><li>Get the item from DynamoDB</li><li>Convert the text to an audio stream</li><li>Put the audio file (MP3) into an S3 bucket</li><li>Update the DynamoDB table with a reference to the S3 bucket and the new state</li></ul><p>The <strong>synthesize_speech</strong> method takes the text to be converted and the voice used. In return, it provides the <strong>audio stream</strong> . The problem is that the input text is limited to 3000 characters. Since a post can be very long, the posts need to be split into blocks of about 2500 characters, depending on the ending position of the last word in the block. After converting the blocks to audio streams, they are concatenated together.</p><ol><li>Select <strong>Deploy</strong>.
<img alt=FWD src=../../../images/lambda4.1.png>
<img alt=FWD src=../../../images/lambda4.png></li></ol><p>Similar to the New Post function, you need to tell this Lambda function which services it can interact with via Environment variables.</p><p>1.Select the <strong>Configuration</strong> tab to configure the environment variables.</p><p>2.In the left navigation pane, select <strong>Environment Variables</strong> .</p><p>3.In the <strong>Environment Variables</strong> section, select <strong>Edit</strong>.</p><ul><li><p>Select Add Environment Variable</p></li><li><p>Key: <strong>EnterDB_TABLE_NAME</strong></p></li><li><p>Value: Enter <strong>posts</strong></p></li><li><p>Select <strong>Add Environment Variable</strong></p></li><li><p>Key: Enter <strong>BUCKET_NAME</strong></p></li><li><p>Value: Enter the name of the bucket you created earlier. The name will look similar to this: <strong>audioposts-123</strong></p></li></ul><p>1.Select <strong>Save</strong>.</p><p>The posts to be converted can be quite large, so you need to extend the maximum execution time of a code to 5 minutes.</p><p>1.In the <strong>General Configuration</strong> section, select <strong>Edit</strong>.</p><ul><li>Update the timeout to 5 minutes.</li></ul><p>1.Select <strong>Save</strong>.</p><p>Now you configure the function to automatically fire when a message is sent to the SNS topic you created earlier.</p><p>1.In the <strong>Triggers</strong> section, select <strong>Add Trigger</strong> and then configure:</p><ul><li>Select source: <strong>SNS</strong></li><li>SNS topic: Choose from the available topics <strong>.new_posts</strong></li></ul><p>1.Select <strong>Add</strong>.</p><p>Now you are ready to test if the two Lambda functions communicate successfully over SNS and generate the Polly audio file.
<img alt=FWD src=../../../images/lambda5.png></p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=../../../2-prerequiste/2.1-createec2/2.1.4-createsecgroup/ title="Create a Lambda Function "><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=../../../2-prerequiste/2.1-createec2/2.1.6-createec2windows/ title="Testing the functions" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=../../../js/clipboard.min.js?1753240738></script><script src=../../../js/perfect-scrollbar.min.js?1753240738></script><script src=../../../js/perfect-scrollbar.jquery.min.js?1753240738></script><script src=../../../js/jquery.sticky.js?1753240738></script><script src=../../../js/featherlight.min.js?1753240738></script><script src=../../../js/highlight.pack.js?1753240738></script><script>hljs.initHighlightingOnLoad()</script><script src=../../../js/modernizr.custom-3.6.0.js?1753240738></script><script src=../../../js/learn.js?1753240738></script><script src=../../../js/hugo-learn.js?1753240738></script><link href=../../../mermaid/mermaid.css?1753240738 rel=stylesheet><script src=../../../mermaid/mermaid.js?1753240738></script><script>mermaid.initialize({startOnLoad:!0})</script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-158079754-2","auto"),ga("send","pageview")</script></body></html>